<!DOCTYPE html>
<html>

<head>
  <title>Send Swap Request</title>
  <style>
    body {
      background-color: #0d0d14;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 40px;
      margin: 0;
    }

    .container {
      max-width: 500px;
      margin: auto;
      background-color: #1a1a2e;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
      border: 1px solid #2c2c3c;
    }

    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #0ea5e9;
    }

    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: bold;
      font-size: 14px;
    }

    select,
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #1c1c2b;
      color: white;
      font-size: 14px;
    }

    select:focus,
    textarea:focus {
      outline: 2px solid #0ea5e9;
    }

    textarea {
      resize: vertical;
      height: 100px;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 25px;
      border: none;
      background-color: #0ea5e9;
      color: black;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background-color: #0c87c6;
    }
  </style>

</head>

<body>

  <div class="container">
    <h2>Send Skill Swap Request</h2>

    <label for="your-skill">Choose one of your offered skills:</label>
    <select id="your-skill"></select>

    <label for="their-skill">Choose one of their wanted skills:</label>
    <select id="their-skill"></select>

    <label for="message">Message:</label>
    <textarea id="message" placeholder="Write a short message..."></textarea>

    <button onclick="submitRequest()">Submit</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = supabase.createClient(
      'https://owypmngmbzpwooyvxehn.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93eXBtbmdtYnpwd29veXZ4ZWhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyOTQxNjUsImV4cCI6MjA2Nzg3MDE2NX0.VPlZZp-vfOy3-bAc4v3rThj6PLfe8_4YsWqWscaz168'
    );

    const urlParams = new URLSearchParams(window.location.search);
    const receiverId = urlParams.get('to');
    let senderId = null;

    async function getSessionUser() {
      const { data: sessionData } = await supabase.auth.getSession();
      senderId = sessionData.session.user.id;
      await loadSenderProfile();
      await loadReceiverProfile();
    }

    async function loadSenderProfile() {
      const { data } = await supabase.from('profiles').select('*').eq('id', senderId).single();
      const offered = data.skills_offered || [];
      const select = document.getElementById('your-skill');
      offered.forEach(skill => {
        const opt = document.createElement('option');
        opt.value = skill;
        opt.textContent = skill;
        select.appendChild(opt);
      });
    }

    async function loadReceiverProfile() {
      const { data } = await supabase.from('profiles').select('*').eq('id', receiverId).single();
      const wanted = data.skills_wanted || [];
      const select = document.getElementById('their-skill');
      wanted.forEach(skill => {
        const opt = document.createElement('option');
        opt.value = skill;
        opt.textContent = skill;
        select.appendChild(opt);
      });
    }

    async function submitRequest() {
      const senderSkill = document.getElementById('your-skill').value;
      const receiverSkill = document.getElementById('their-skill').value;
      const message = document.getElementById('message').value;

      const { error } = await supabase.from('swaps').insert({
        sender_id: senderId,
        receiver_id: receiverId,
        sender_skill: senderSkill,
        receiver_skill: receiverSkill,
        message,
        status: 'pending'
      });

      if (!error) {
        alert("Swap Request Sent!");
        window.location.href = "profile.html?id=" + receiverId;
      } else {
        alert("Error sending request");
      }
    }

    getSessionUser();

    
  </script>
</body>

</html>